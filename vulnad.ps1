

#Base Lists 
$Global:Username = @('Obi-Wan_Kenobi', 'Han_Solo', 'Luke_Skywalker', 'Yoda', 'Darth_Vader', 'R2-D2', 'Darth_Maul', 'Chewbacca', 'Princess_Leia', 'General_Grievous', 'C-3PO', 'Emperor_Palpatine', 'Boba_Fett', 'Jabba_The_Hutt', 'Lando_Calrissian', 'Mace_Windu', 'Padme_Amidala', 'Count_Dooku', 'Qui-Gon_Jinn', 'Asajj_Ventress', 'Plo_Koon', 'Ben_Skywalker', 'Kit_Fisto', 'Jango_Fett', 'Ahsoka_Tano', 'Admiral_Ackbar', 'Wedge_Antilles', 'Ki-Adi-Mundi', 'Shaak_Ti', 'Senator_Bail_Organa', 'Grand_Moff_Tarkin', 'Captain_Rex', 'Darth_Bane', 'Darth_Nihilus', 'Aurra_Sing', 'Quinlan_Vos', 'Luminara_Unduli', 'Clone_Commander_Cody', 'Admiral_Thrawn', 'Kylo_Ren', 'Rey', 'BB-8', 'Darth_Malgus', 'Admiral_Piett', 'Owen_Lars', 'Beru_Lars', 'Clone_Commander_Gree', 'Darth_Plagueis', 'Clone_Commander_Bly', 'Lord_Kaan', 'Biggs_Darklighter', 'Kanan_Jarrus', 'Poe_Dameron', 'Greedo', 'Bossk', 'Aayla_Secura', 'Clone_Commander_Fox', 'Clone_Commander_Thire', 'Clone_Commander_Appo', 'Clone_Commander_Bacara', 'Clone_Commander_Neyo', 'Nute_Gunray', 'Captain_Phasma', 'Dengar', 'Zuckuss', 'Wicket', 'Barriss_Offee', 'Adi_Gallia', 'General_Veers', 'Mon_Mothma', 'Pre_Vizsla', 'Saesee_Tiin', 'Admiral_Motti', 'Captain_Gregar_Typho', 'Even_Piell', 'Gardulla_the_Hutt', 'Jek_Porkins', 'Mother_Talzin', 'Wat_Tambor', 'Rune_Haako', 'Orn_Free_Taa', 'Durga_The_Hutt', 'Yaddle', 'Cade_Skywalker', '4-LOM', 'Carnor_Jax', 'Durge', 'Agen_Kolar', 'Shmi_Skywalker', 'Dash_Rendar', 'Kir_Kanos', 'General_Crix_Madine', 'Kol_Skywalker', 'Lumiya', 'Natasi_Daala', 'Gilad_Pellaeon', 'Depa_Billaba', 'Lon_Secura', 'Nat_Secura', 'Pol_Secura', 'Prince_Xizor', 'Mas_Amedda', 'Sly_Moore', 'Jerec', 'Satele_Shan', 'Nien_Nunb', 'Yarael_Poof', "Kh'aris_Fenn", 'Lott_Dod', 'Kyp_Durron', 'Bib_Fortuna', 'IG_88', 'Darth_Wyyrlok', 'Ulic_Qel-Droma', 'Ro_Fenn', 'Watto', 'Stass_Allie', 'Cassus_Fett', 'Tarfful', "T'ra_Saa", 'Master_Tholme', 'Lowbacca', 'Sebulba', 'Zayne_Carrick', 'Passel_Argente', "J'Mikel", 'Peerce', 'Sha_Koon', 'Sharad_Hett', 'Vilmarh_Grahrk', 'Cay_Qel-Droma', 'Oppo_Rancisis', 'Admiral_Ozzel', 'Duron_Qel-Droma', 'Senator_Valorum', 'Doltay_Dofine', 'Chief_Chirpa', 'Sy_Snootles', 'Tessek', 'Ree-Yees', 'Max_Rebo', 'Logray', 'Lobot', 'Mirta_Gev', 'Wes_Janson', 'Coleman_Trebor', 'Lushros_Dofine', 'Denaria_Kee', 'Governor_Sio_Bibble', 'Clone_Commander_Faie', 'Ric_Ollie', 'Taun_We', 'RC-1138', 'RC-1262', 'RC-1136', 'RC-1207', 'RC-1309', 'RC-1140', 'Sabe', 'Roron_Corobb',
'Ponda_Baba', 'Dexter_Jettster', 'Savan', 'Jocasta_Nu', 'Wolf_Sazen', 'Bultar_Swan', 'Fo_Kuna', 'Gasgano', 'Poggle_the_Lesser', 'Jaster_Mereel', 'Ben_Quadinaros', 'Tion_Medon', 'San_Hill', 'Darth_Maleval', 'Sei_Taria', 'Snoova', 'Teebo', 'Bok', 'Alpha-17', 'Grappa_the_Hutt', 'Sun_Fac', 'TC-14');
$Global:BadPasswords = @('test', '123456', '12345', '123456789', 'password', 'iloveyou', 'princess', '1234567', 'rockyou', '12345678', 'abc123', 'nicole', 'daniel', 'babygirl', 'monkey', 'lovely', 'jessica', '654321', 'michael', 'ashley', 'qwerty', '111111', 'iloveu', '000000', 'michelle', 'tigger', 'sunshine', 'chocolate', 'password1', 'soccer', 'anthony', 'friends', 'butterfly', 'purple', 'angel', 'jordan', 'liverpool', 'justin', 'loveme', 'fuckyou', '123123', 'football', 'secret', 'andrea', 'carlos', 'jennifer', 'joshua', 'bubbles', '1234567890', 'superman', 'hannah', 'amanda', 'loveyou', 'pretty', 'basketball', 'andrew', 'angels', 'tweety', 'flower', 'playboy', 'hello', 'elizabeth', 'hottie', 'tinkerbell', 'charlie', 'samantha', 'barbie', 'chelsea', 'lovers', 'teamo', 'jasmine', 'brandon', '666666', 'shadow', 'melissa', 'eminem', 'matthew', 'robert', 'danielle', 'forever', 'family', 'jonathan', '987654321', 'computer', 'whatever', 'dragon', 'vanessa', 'cookie', 'naruto', 'summer', 'sweety', 'spongebob', 'joseph', 'junior', 'softball', 'taylor', 'yellow', 'daniela', 'lauren', 'mickey', 'princesa', 'alexandra', 'alexis', 'jesus', 'estrella', 'miguel', 'william', 'thomas', 'beautiful', 'mylove', 'angela', 'poohbear', 'patrick', 'iloveme', 'sakura', 'adrian', 'alexander', 'destiny', 'christian', '121212', 'sayang', 'america', 'dancer', 'monica', 'richard', '112233', 'princess1', '555555', 'diamond', 'carolina', 'steven', 'rangers', 'louise', 'orange', '789456', '999999', 'shorty', '11111', 'nathan', 'snoopy', 'gabriel', 'hunter', 'cherry', 'killer', 'sandra', 'alejandro', 'buster', 'george', 'brittany', 'alejandra', 'patricia', 'rachel', 'tequiero', '7777777', 'cheese', '159753', 'arsenal', 'dolphin', 'antonio', 'heather', 'david', 'ginger', 'stephanie', 'peanut', 'blink182', 'sweetie', '222222', 'beauty', '987654', 'victoria', 'honey', '00000', 'fernando', 'pokemon', 'maggie', 'corazon', 'chicken', 'pepper', 'cristina', 'rainbow', 'kisses', 'manuel', 'myspace', 'rebelde', 'angel1', 'ricardo', 'babygurl', 'heaven', '55555', 'baseball', 'martin', 'greenday', 'november', 'alyssa', 'madison', 'mother', '123321', '123abc', 'mahalkita', 'batman', 'september', 'december', 'morgan', 'mariposa', 'maria', 'gabriela', 'iloveyou2', 'bailey', 'jeremy', 'pamela', 'kimberly', 'gemini', 'shannon', 'pictures', 'asshole', 'sophie', 'jessie', 'hellokitty', 'claudia', 'babygirl1', 'angelica', 'austin', 'mahalko', 'victor', 'horses', 'tiffany', 'mariana', 'eduardo', 'andres', 'courtney', 'booboo', 'kissme', 'harley', 'ronaldo', 'iloveyou1', 'precious', 'october', 'inuyasha', 'peaches', 'veronica', 'chris', '888888', 'adriana', 'cutie',
'james', 'banana', 'prince', 'friend', 'jesus1', 'crystal');
$Global:HighGroups = @('Office Admin','IT Admins','Executives');
$Global:MidGroups = @('Senior management','Project management');
$Global:NormalGroups = @('marketing','sales','accounting');
$Global:BadACL = @('GenericAll','GenericWrite','WriteOwner','WriteDACL','Self');
$Global:ServicesAccountsAndSPNs = @('mssql_svc,mssqlserver','http_svc,httpserver','exchange_svc,exserver');
$Global:CreatedUsers = @();
$Global:AllObjects = @();
$Global:Domain = "";
#Strings 
$Global:Spacing = "`t"
$Global:PlusLine = "`t[+]"
$Global:ErrorLine = "`t[-]"
$Global:InfoLine = "`t[*]"
function Write-Good { param( $String ) Write-Host $Global:PlusLine  $String -ForegroundColor 'Green'}
function Write-Bad  { param( $String ) Write-Host $Global:ErrorLine $String -ForegroundColor 'red'  }
function Write-Info { param( $String ) Write-Host $Global:InfoLine $String -ForegroundColor 'gray' }
function ShowBanner {
    $banner  = @()
    $banner+= $Global:Spacing + ''
    $banner+= $Global:Spacing + '██╗   ██╗██╗   ██╗██╗     ███╗   ██╗ █████╗ ██████╗ '
    $banner+= $Global:Spacing + '██║   ██║██║   ██║██║     ████╗  ██║██╔══██╗██╔══██╗'
    $banner+= $Global:Spacing + '██║   ██║██║   ██║██║     ██╔██╗ ██║███████║██║  ██║'
    $banner+= $Global:Spacing + '╚██╗ ██╔╝██║   ██║██║     ██║╚██╗██║██╔══██║██║  ██║'
    $banner+= $Global:Spacing + ' ╚████╔╝ ╚██████╔╝███████╗██║ ╚████║██║  ██║██████╔╝'
    $banner+= $Global:Spacing + '  ╚═══╝   ╚═════╝ ╚══════╝╚═╝  ╚═══╝╚═╝  ╚═╝╚═════╝'
    $banner+= $Global:Spacing + ''                                                  
    $banner+= $Global:Spacing + 'By wazehell @safe_buffer'
    $banner | foreach-object {
        Write-Host $_ -ForegroundColor (Get-Random -Input @('Green','Cyan','Yellow','gray','white'))
    }                             
}

function VulnAD-GetRandom {
   Param(
     [array]$InputList
   )
   return Get-Random -InputObject $InputList
}

function VulnAD-AddADGroup {
    Param(
        [array]$GroupList
    )
    foreach ($group in $GroupList) {
        Write-Info "Creating $group Group"
        Try { New-ADGroup -name $group -GroupScope Global } Catch {}
        for ($i=1; $i -le (Get-Random -Maximum 20); $i=$i+1 ) {
            $randomuser = (VulnAD-GetRandom -InputList $Global:CreatedUsers)
            Write-Info "Adding $randomuser to $group"
            Try { Add-ADGroupMember -Identity $group -Members $randomuser } Catch {}
        }
        $Global:AllObjects += $group;
    }
}
function VulnAD-AddADUser {
    Param(
        [int]$limit = 1
    )
    Add-Type -AssemblyName System.Web
    for ($i=1; $i -le $limit; $i=$i+1 ) {
        $firstname = ($Global:Username[$i]);
        $SamAccountName = ("{0}" -f ($firstname)).ToLower();
        $principalname = "{0}" -f ($firstname);
        $generated_password = ($Global:BadPasswords[$i])
        Write-Info "Creating $SamAccountName User"
        Try { New-ADUser -Name "$firstname" -GivenName $firstname -SamAccountName $SamAccountName -UserPrincipalName $principalname@$Global:Domain -AccountPassword (ConvertTo-SecureString $generated_password -AsPlainText -Force) -PassThru | Enable-ADAccount } Catch {}
        $Global:CreatedUsers += $SamAccountName;
    }

}
function VulnAD-AddACL {
        [CmdletBinding()]
        param(
            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [string]$Destination,

            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [System.Security.Principal.IdentityReference]$Source,

            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [string]$Rights

        )
        $ADObject = [ADSI]("LDAP://" + $Destination)
        $identity = $Source
        $adRights = [System.DirectoryServices.ActiveDirectoryRights]$Rights
        $type = [System.Security.AccessControl.AccessControlType] "Allow"
        $inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "All"
        $ACE = New-Object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$inheritanceType
        $ADObject.psbase.ObjectSecurity.AddAccessRule($ACE)
        $ADObject.psbase.commitchanges()
}
function VulnAD-BadAcls {
    foreach ($abuse in $Global:BadACL) {
        $ngroup = VulnAD-GetRandom -InputList $Global:NormalGroups
        $mgroup = VulnAD-GetRandom -InputList $Global:MidGroups
        $DstGroup = Get-ADGroup -Identity $mgroup
        $SrcGroup = Get-ADGroup -Identity $ngroup
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $ngroup to $mgroup"
    }
    foreach ($abuse in $Global:BadACL) {
        $hgroup = VulnAD-GetRandom -InputList $Global:HighGroups
        $mgroup = VulnAD-GetRandom -InputList $Global:MidGroups
        $DstGroup = Get-ADGroup -Identity $hgroup
        $SrcGroup = Get-ADGroup -Identity $mgroup
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $mgroup to $hgroup"
    }
    for ($i=1; $i -le (Get-Random -Maximum 25); $i=$i+1 ) {
        $abuse = (VulnAD-GetRandom -InputList $Global:BadACL);
        $randomuser = VulnAD-GetRandom -InputList $Global:CreatedUsers
        $randomgroup = VulnAD-GetRandom -InputList $Global:AllObjects
        if ((Get-Random -Maximum 2)){
            $Dstobj = Get-ADUser -Identity $randomuser
            $Srcobj = Get-ADGroup -Identity $randomgroup
        }else{
            $Srcobj = Get-ADUser -Identity $randomuser
            $Dstobj = Get-ADGroup -Identity $randomgroup
        }
        VulnAD-AddACL -Source $Srcobj.sid -Destination $Dstobj.DistinguishedName -Rights $abuse 
        Write-Info "BadACL $abuse $randomuser and $randomgroup"
    }
}
function VulnAD-Kerberoasting {
    $selected_service = (VulnAD-GetRandom -InputList $Global:ServicesAccountsAndSPNs)
    $svc = $selected_service.split(',')[0];
    $spn = $selected_service.split(',')[1];
    $password = VulnAD-GetRandom -InputList $Global:BadPasswords;
    Write-Info "Kerberoasting $svc $spn"
    Try { New-ADServiceAccount -Name $svc -ServicePrincipalNames "$svc/$spn.$Global:Domain" -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -RestrictToSingleComputer -PassThru } Catch {}
    foreach ($sv in $Global:ServicesAccountsAndSPNs) {
        if ($selected_service -ne $sv) {
            $svc = $sv.split(',')[0];
            $spn = $sv.split(',')[1];
            Write-Info "Creating $svc services account"
            $password = ([System.Web.Security.Membership]::GeneratePassword(12,2))
            Try { New-ADServiceAccount -Name $svc -ServicePrincipalNames "$svc/$spn.$Global:Domain" -RestrictToSingleComputer -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -PassThru } Catch {}

        }
    }
}
function VulnAD-ASREPRoasting {
    for ($i=1; $i -le (Get-Random -Maximum 6); $i=$i+1 ) {
        $randomuser = (VulnAD-GetRandom -InputList $Global:CreatedUsers)
        $password = VulnAD-GetRandom -InputList $Global:BadPasswords;
        Set-AdAccountPassword -Identity $randomuser -Reset -NewPassword (ConvertTo-SecureString $password -AsPlainText -Force)
        Set-ADAccountControl -Identity $randomuser -DoesNotRequirePreAuth 1
        Write-Info "AS-REPRoasting $randomuser"
    }
}
function VulnAD-DnsAdmins {
    for ($i=1; $i -le (Get-Random -Maximum 6); $i=$i+1 ) {
        $randomuser = (VulnAD-GetRandom -InputList $Global:CreatedUsers)
        Add-ADGroupMember -Identity "DnsAdmins" -Members $randomuser
        Write-Info "DnsAdmins : $randomuser"
    }
    $randomg = (VulnAD-GetRandom -InputList $Global:MidGroups)
    Add-ADGroupMember -Identity "DnsAdmins" -Members $randomg
    Write-Info "DnsAdmins Nested Group : $randomg"
}
function VulnAD-DefaultPassword
 {
    for ($i=1; $i -le (Get-Random -Maximum 6); $i=$i+1 ) {
        $randomuser = (VulnAD-GetRandom -InputList $Global:CreatedUsers)
        $password = ([System.Web.Security.Membership]::GeneratePassword(12,2))
        Set-AdAccountPassword -Identity $randomuser -Reset -NewPassword (ConvertTo-SecureString $password -AsPlainText -Force)
        Set-ADUser $randomuser -Description "need to be changed $password"
        Write-Info "Password in Description : $randomuser"
    }
}
function VulnAD-PasswordSpraying {
    $same_password = ([System.Web.Security.Membership]::GeneratePassword(12,2))
    for ($i=1; $i -le (Get-Random -Maximum 12); $i=$i+1 ) {
        $randomuser = (VulnAD-GetRandom -InputList $Global:CreatedUsers)
        Set-AdAccountPassword -Identity $randomuser -Reset -NewPassword (ConvertTo-SecureString $same_password -AsPlainText -Force)
        Set-ADUser $randomuser -Description "default password"
        Write-Info "Same Password (Password Spraying) : $randomuser"
    }
}
function VulnAD-DCSync {
    for ($i=1; $i -le (Get-Random -Maximum 6); $i=$i+1 ) {
        $randomuser = (VulnAD-GetRandom -InputList $Global:CreatedUsers)

        $userobject = (Get-ADUser -Identity $randomuser).distinguishedname
        $ACL = Get-Acl -Path "AD:\$userobject"
        $sid = (Get-ADUser -Identity $randomuser).sid

        $objectGuidGetChanges = New-Object Guid 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2
        $ACEGetChanges = New-Object DirectoryServices.ActiveDirectoryAccessRule($sid,'ExtendedRight','Allow',$objectGuidGetChanges)
        $ACL.psbase.AddAccessRule($ACEGetChanges)

        $objectGuidGetChanges = New-Object Guid 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2
        $ACEGetChanges = New-Object DirectoryServices.ActiveDirectoryAccessRule($sid,'ExtendedRight','Allow',$objectGuidGetChanges)
        $ACL.psbase.AddAccessRule($ACEGetChanges)

        $objectGuidGetChanges = New-Object Guid 89e95b76-444d-4c62-991a-0facbeda640c
        $ACEGetChanges = New-Object DirectoryServices.ActiveDirectoryAccessRule($sid,'ExtendedRight','Allow',$objectGuidGetChanges)
        $ACL.psbase.AddAccessRule($ACEGetChanges)

        Set-ADUser $randomuser -Description "Replication Account"
        Write-Info "Giving DCSync to : $randomuser"
    }
}
function VulnAD-DisableSMBSigning {
    Set-SmbClientConfiguration -RequireSecuritySignature 0 -EnableSecuritySignature 0 -Confirm -Force
}

function Invoke-VulnAD {
    Param(
        [int]$UsersLimit = 100,
        [Parameter(Mandatory=$True,ValueFromPipeline=$True,ValueFromPipelineByPropertyName=$True,Position=1)]
        [ValidateNotNullOrEmpty()]
        [System.String]
        $DomainName
    )
    ShowBanner
    $Global:Domain = $DomainName
    Set-ADDefaultDomainPasswordPolicy -Identity $Global:Domain -LockoutDuration 00:01:00 -LockoutObservationWindow 00:01:00 -ComplexityEnabled $false -ReversibleEncryptionEnabled $False -MinPasswordLength 4
    VulnAD-AddADUser -limit $UsersLimit
    Write-Good "Users Created"
    VulnAD-AddADGroup -GroupList $Global:HighGroups
    Write-Good "$Global:HighGroups Groups Created"
    VulnAD-AddADGroup -GroupList $Global:MidGroups
    Write-Good "$Global:MidGroups Groups Created"
    VulnAD-AddADGroup -GroupList $Global:NormalGroups
    Write-Good "$Global:NormalGroups Groups Created"
    VulnAD-BadAcls
    Write-Good "BadACL Done"
    VulnAD-Kerberoasting
    Write-Good "Kerberoasting Done"
    VulnAD-ASREPRoasting
    Write-Good "AS-REPRoasting Done"
    VulnAD-DnsAdmins
    Write-Good "DnsAdmins Done"
    VulnAD-DefaultPassword
    Write-Good "Leaked Password Done"
    VulnAD-PasswordSpraying
    Write-Good "Password Spraying Done"
    VulnAD-DCSync
    Write-Good "DCSync Done"
    VulnAD-DisableSMBSigning
    Write-Good "SMB Signing Disabled"
}
